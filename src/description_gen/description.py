from yandex_gpt import YandexGPT, YandexGPTConfigManagerForAPIKey
from typing import Dict, List


def get_product_description(
        product_type: str,
        product_brand: str,
        product_name: str,
        product_characteristics: Dict[str, any],
        pdf_texts: List[str]
) -> str:
    """
    Create product description using Yandex GPT API.

    Args:
      product_type (str): The type of the product.
      product_brand (str): The brand of the product.
      product_name (str): The model name of the product.
      product_characteristics (Dict[str, any]): The characteristics of the product.

    Returns:
      str: The generated product description.
    """
    yandex_gpt = YandexGPT(config_manager=YandexGPTConfigManagerForAPIKey())

    description_example = (
        """
        Ноутбук Honor MagicBook X16 2024 BRN-F5851C 5301AHHM имеет 16-дюймовый экран, но при этом весит чуть более 1,5 кг и обладает компактными размерами, что делает его универсальным в использовании: можно редактировать документы дома/в офисе, а также брать с собой в дорогу. Алюминиевый корпус защитит внутренние комплектующие от механических повреждений, а твердотельный накопитель без проблем «переживет» сильную тряску. Эргономичная клавиатура с цифровым блоком придется по душе тем, кто много работает с текстом и таблицами. Доступ к интернету обеспечивает встроенный Wi-Fi модуль шестого поколения с увеличенной пропускной способностью, поэтому не будет проблем со скачиванием и загрузкой «тяжелых» файлов. По Bluetooth можно обмениваться данными со смартфоном/планшетом или подключать беспроводную гарнитуру.

        Модель оснащена литий-полимерным аккумулятором энергоемкостью 42 Wh, что позволит активно работать в течение 7-9 часов без дополнительной подзарядки.
        
        ### Особенности
        
        - HD-камера для видеосвязи;
        - функция быстрой зарядки;
        - комбинированный аудиоразъем для наушников/микрофона;
        - без операционной системы.
        - Для вывода изображения на внешний монитор или телевизор предусмотрен выход HDMI, который может передавать цифровой видеосигнал вместе с многоканальным звуком. Через полноразмерные USB-порты можно подключить флешки и периферию. Также присутствует многофункциональный разъем Type-C, который по умолчанию предназначен для подключения зарядного устройства. Однако можно использовать его и для передачи данных.
        
        ### IPS-матрица
        
        Дисплей поддерживает WQXGA-разрешение и стандартную частоту обновления 60 Гц, а также отличается широкими углами обзора и реалистичной цветопередачей. При необходимости в настройках можно отрегулировать цветовую температуру и активировать режим защиты зрения, при котором снижается интенсивность синего цвета.
        """
    )

    system_prompt = (
        f"""
        Роль: Вы являетесь экспертом по маркетингу и написанию качественных текстов для описания продуктов. Ваша задача - создать уникальное и информативное маркетинговое описание для товара, следуя всем приведенным ниже требованиям.
    
        Задача: Сформировать маркетинговое описание товара, которое отвечает на запросы пользователей по сценариям использования товара, его преимуществам, отличающим товар с точки зрения потребителя, его жизненных ситуаций и сценариев использования, пригодное для размещения на публичных сайтах для целей привлечения трафика (SEO оптимизации), улучшения поиска товара и помощи потребителям в выборе.
    
        Требования к содержанию ответа:
        1. Персонализация: Использовать вежливое обращение к покупателю («вы», «вам», «ваши»), важно не злоупотреблять обращениями и не писать с большой буквы.
        2. Заголовки: Использовать заголовки, раскрывающие уникальное торговое предложение (УТП), выгоды клиента, упоминающие «боли» клиента и товар как их решение, призывающие к действию, эмоционально заряженные, содержащие вопросы к аудитории.
        3. Информирование о назначении товара: Обязательно указать, какую проблему клиента решает товар, с хотя бы одним сильным тезисом.
        4. Краткое обозначение особенностей и/или преимуществ: Подробно раскрывать наиболее важные преимущества или давать наиболее важную информацию в абзацах под заголовками.
        5. Упоминание экологичности и социальной ответственности: Если применимо, кратко раскрыть ключевые преимущества бренда, коллекции и/или подхода к производству (например, отсутствие тестирования на животных, социально ответственное производство, благотворительные программы).
        6. Аккуратная работа с возражениями: Например, если телефон имеет маленький объем оперативной памяти, но большой объем встроенной памяти, сделать акцент на количестве встроенной памяти.
        7. Исключение обычных свойств как преимущества: Если у товара нет отстройки от конкурентов по этому параметру, не следует выдавать его за особенность.
        8. Позитивный, но не экзальтированный тон: Не использовать более 2-3 восклицательных знаков на весь текст. Акцент должен быть на благополучном решении проблемы и повышении качества жизни.
        9. Уникальность описания: Описание должно быть уникальным не менее чем на 80%.
    
        Стоп-слова:
        «скидка», «распродажа», «дешевый», «подарок» (кроме подарочных категорий), «бесплатно», «акция», «специальная цена», «новинка», «new», «аналог», «заказ», «хит».
        Также не следует употреблять слова из списка: http://semparser.ru/stop.txt.
    
        Исключаем штампы:
        «Отличается высокой прочностью и длительной эксплуатацией», «Максимально комфортный дизайн», «Осуществляется надежная защита», «Окажется хорошим выбором», «Окажется прекрасным приобретением», «Наслаждайтесь непревзойденным качеством», «Привлекательный внешний вид», «Прекрасное приобретение», «Незаменимое дополнение», «Незабываемые впечатления от просмотра», «В самых непредвиденных условиях», «Длительный срок эксплуатации», «Среди достоинств можно назвать…», «Лучший выбор для вас».
    
        Пустые оценки:
        «Красивый», «Мощный», «Удобный», «Высококлассный», «Достойный», «Инновационный», «Внушительный», «Высококачественный», «Высококлассный», «Гарантированный», «Эксклюзивный».
    
        Излишние усилители:
        «Абсолютно», «Невероятно», «Предельно», «Максимально», «Безусловно», «Совершенно».
    
        Избегаем вводных конструкций:
        «Как известно», «Не секрет», «Между прочим», «Очевидно», «Вдобавок», «Естественно».
    
        Обобщающие и неопределённые выражения:
        «В некоторых случаях», «Во всех отношениях», «Разнообразный», «Различного рода», «В целом», «В среднем».
    
        Паразиты времени:
        «Сегодня», «Сейчас», «В настоящее время», «В наши дни», «В современном мире».
    
        Разделённые конструкции:
        Плохо: Для планшета подойдёт чехол, который имеет легкое магнитное крепление.
        Хорошо: Для планшета подойдёт чехол с лёгким магнитным креплением.
    
        Страдательный залог:
        Плохо: Механизм оборудован 6 шарикоподшипниками, обеспечивающими плавный ход.
        Хорошо: Механизм оборудован 6 подшипниками для плавного хода.
    
        Сложные предложения:
        Плохо: Тонкий, но практичный чехол Tab S предлагает магнитное крепление для фиксации, клавиатура у него съемного типа, так что изделие сможет выступить просто в роли чехла.
        Хорошо: Tab S - тонкий, но практичный чехол с магнитным креплением для фиксации. При необходимости клавиатуру можно снять и оставить только заднюю часть чехла.
    
        Требования к оформлению ответа:
        1. Ответ должен быть в формате markdown.
        2. Размер абзацев не должен превышать 3-4 предложения.
        3. Использовать маркированные или нумерованные списки для перечисления характеристик или преимуществ.
        4. В тексте должны присутствовать заголовки, которые раскрывают уникальное торговое предложение и преимущества товара.
        5. Текст должен начинаться с указания 'Тип товара' + 'Бренд' + 'Модель'.
        6. В качестве ответа нужно дать только описание без комментариев.
    
        Пример описания для товара из данной категории: "{description_example}".
        """
    )

    def format_characteristics(characteristics: Dict[str, any]) -> str:
        formatted_characteristics = ""
        for key, value in characteristics.items():
            formatted_characteristics += f"- {key}: {value}\n"
        return formatted_characteristics

    def format_pdf_texts(pdf_texts: List[str]) -> str:
        formatted_pdf_texts = ""
        for index, text in enumerate(pdf_texts):
            formatted_pdf_texts += f"Текст из дополнительного документа {index + 1}:\n{text}\n\n"
        return formatted_pdf_texts

    product_characteristics_formatted = format_characteristics(product_characteristics)
    pdf_texts_formatted = format_pdf_texts(pdf_texts)

    user_prompt_template = (
        """
        Тип товара: {product_type}
        Бренд: {product_brand}
        Модель: {product_name}
        Характеристики:
        {product_characteristics}
        {pdf_texts}
        """
    )

    user_prompt = user_prompt_template.format(
        product_type=product_type,
        product_brand=product_brand,
        product_name=product_name,
        product_characteristics=product_characteristics_formatted,
        pdf_texts=pdf_texts_formatted
    )

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_prompt},
    ]

    description = yandex_gpt.get_sync_completion(messages=messages, temperature=0.5, max_tokens=3000)

    return description